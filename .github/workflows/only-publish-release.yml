name: Publish Local Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.2.6)'
        required: true
        default: 'v0.2.6'

permissions:
  contents: write

jobs:
  release:
    name: Publish from Runner Files
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verify local build files
        shell: pwsh
        run: |
          $installer = "build/windows/FMGoalMusicInstaller.exe"
          $binary = "build/windows/fm-goal-musics-gui.exe"

          Write-Host "üîç Checking for local build files..."
          if (-not (Test-Path $installer)) {
            Write-Error "‚ùå Missing installer: $installer"
            exit 1
          }
          if (-not (Test-Path $binary)) {
            Write-Error "‚ùå Missing main binary: $binary"
            exit 1
          }

          Write-Host "‚úÖ Found both build files."
          Get-ChildItem build/windows | Format-Table Name, Length, LastWriteTime

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          name: "FM Goal Musics ${{ inputs.version }}"
          files: |
            build/windows/FMGoalMusicInstaller.exe
            build/windows/fm-goal-musics-gui.exe
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
