name: Publish Local Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.2.6)'
        required: true
        default: 'v0.2.6'

permissions:
  contents: write

jobs:
  release:
    name: Publish from Local Runner Files
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verify local build files (absolute path fix)
        shell: pwsh
        run: |
          $repoRoot = Get-Location
          Write-Host "üìÇ Current working directory: $repoRoot"

          $installer = Join-Path $repoRoot "build/windows/FMGoalMusicInstaller.exe"
          $binary = Join-Path $repoRoot "build/windows/fm-goal-musics-gui.exe"

          Write-Host "üîç Checking for local build files..."
          Write-Host "  Installer path: $installer"
          Write-Host "  Binary path: $binary"

          if (-not (Test-Path $installer)) {
            Write-Error "‚ùå Missing installer: $installer"
            exit 1
          }
          if (-not (Test-Path $binary)) {
            Write-Error "‚ùå Missing main binary: $binary"
            exit 1
          }

          Write-Host "‚úÖ Found both build files successfully!"
          Get-ChildItem (Join-Path $repoRoot "build/windows") | Format-Table Name, Length, LastWriteTime

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          name: "FM Goal Musics ${{ inputs.version }}"
          files: |
            build/windows/FMGoalMusicInstaller.exe
            build/windows/fm-goal-musics-gui.exe
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
